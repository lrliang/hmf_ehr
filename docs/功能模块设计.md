# HR管理系统功能模块设计

## 1. 系统整体架构

### 1.1 技术栈选择
- **前端**：React + TypeScript + Ant Design
- **后端**：Node.js + Express + TypeScript
- **数据库**：MySQL + Redis
- **部署**：Docker + Nginx

### 1.2 系统模块划分
```
HR管理系统
├── 用户认证模块
├── 员工管理模块
├── 考勤管理模块
├── 假勤管理模块
├── 目标管理模块
├── 薪酬管理模块
├── 报表统计模块
└── 系统管理模块
```

## 2. 核心功能模块

### 2.1 员工管理模块
- 员工基本信息管理
- 员工档案管理
- 员工状态管理
- 员工调动记录

### 2.2 考勤管理模块
- 考勤规则配置
- 考勤打卡记录
- 考勤数据统计
- 考勤异常处理
- Excel批量导入考勤数据
- 考勤日报自动计算与生成
- 考勤月报自动汇总与生成

#### 2.2.1 考勤日报自动计算功能
- **智能计算引擎**: 基于AttendanceRecord数据自动计算各项考勤指标
  - 首末打卡时间：当天最早和最晚的打卡时间
  - 日出勤状态：正常/迟到/早退/缺勤/加班等状态判断
  - 迟到时长（分钟）：精确计算实际打卡时间与应打卡时间的差值
  - 早退时长（分钟）：提前离开的时间统计
  - 加班时长分类：工作日/公休日/法定假日加班时间分类统计
  - 实际工作时长（小时）：最早上班到最晚下班时间（扣除午休）
  - 公出时长（小时）：基于备注信息智能识别公出记录
  - 法定假日判断：基于日期自动识别法定假日
  - 补卡次数统计：手动补签记录的数量统计
  - 各类假期天数：年假、事假、病假、产假、陪产假等
- **自动化触发机制**:
  - 定时任务：每日凌晨2点自动计算前一天考勤日报
  - 导入触发：Excel数据导入完成后自动触发相关日期的日报计算
  - 手动触发：支持指定日期范围的手动计算
- **计算状态管理**: SUCCESS/FAILED/PENDING/PROCESSING四种状态
- **容错处理**: 计算失败时记录详细错误信息，不影响整体流程

#### 2.2.2 考勤月报自动汇总功能
- **基于日报的智能汇总**: 从日报数据自动生成月报统计
  - 出勤统计：应出勤天数、实出勤天数、缺勤天数统计
  - 时间汇总：迟到总时长、早退总时长、加班时间分类汇总
  - 假期统计：各种类型假期天数的月度汇总
  - 异常汇总：补卡次数、异常考勤情况统计
- **自动化触发机制**:
  - 日报完成触发：日报计算完成后自动触发相关月份的月报计算
  - 定时任务集成：每日定时任务自动包含月报计算
  - 手动触发：支持指定月份的手动月报计算
- **状态流程管理**: DRAFT→PENDING→CONFIRMED→LOCKED状态流转
- **智能保护机制**: 已确认月报不会被重复计算，保护数据完整性

### 2.3 假勤管理模块
- 请假类型管理
- 请假申请流程
- 请假额度管理
- 请假记录查询

### 2.4 目标管理模块
- 目标设定
- 目标进度跟踪
- 目标完成评估
- 目标调整申请

### 2.5 薪酬管理模块
- 薪酬结构配置
- 基于考勤数据的工资自动计算
- 工资详情管理和状态流转
- 薪酬发放管理和确认流程
- 薪酬报表和统计分析

#### 2.5.1 工资自动计算功能
- **智能工资计算引擎**: 基于员工基础薪资和月度考勤报告自动计算
  - 日工资计算：月标准工资 ÷ 21.75天
  - 小时工资计算：日工资 ÷ 8小时
  - 正常出勤工资：基于实际出勤比例计算
  - 事假扣款：日工资 × 事假天数
  - 休息日加班费：日工资 × 200% × 加班天数
  - 法定节假日加班费：日工资 × 300% × 加班天数
  - 延时加班费：小时工资 × 150% × 加班小时数
  - 补助奖金：出差补贴、值班补贴等自动计入
- **计算触发机制**:
  - 手动触发：支持单月或批量多月工资计算
  - 基于已确认的月度考勤报告进行计算
  - 支持强制重新计算功能
  - 防重复计算保护机制
- **状态流转管理**: DRAFT→CALCULATED→CONFIRMED→PAID状态流程
- **数据审计追溯**: 完整的计算快照记录，支持溯源分析

#### 2.5.2 工资管理流程
- **计算阶段**: 系统自动基于考勤数据计算工资
- **确认阶段**: HR管理员审核确认工资详情
- **发放阶段**: 标记工资发放状态和时间
- **统计分析**: 月度工资统计和状态分布

## 3. 数据库设计

### 3.1 核心数据表
- 员工表 (employees)
- 考勤记录表 (attendance_records)
- 考勤日报表 (attendance_daily_reports) - 新增
- 考勤月报表 (attendance_monthly_reports) - 新增
- 工资详情表 (salary_details) - 新增
- 请假申请表 (leave_applications)
- 目标表 (goals)
- 薪酬记录表 (salary_records)

#### 3.1.1 考勤日报表 (attendance_daily_reports)
- **主要字段**:
  - employeeId: 员工ID（外键）
  - reportDate: 报告日期
  - employeeNo: 员工工号
  - realName: 真实姓名
  - nickname: 员工昵称
  - companyEmail: 公司邮箱
  - primaryDepartment: 一级部门
  - firstCheckIn: 首打卡时间
  - lastCheckOut: 末打卡时间
  - dailyAttendanceStatus: 日出勤状态
  - legalHolidayDays: 法定假日天数
  - makeupCardCount: 补卡次数
  - annualLeaveDays: 年假天数
  - personalLeaveDays: 事假天数
  - sickLeaveDays: 病假天数
  - bereavementLeaveDays: 丧假天数
  - childcareLeaveDays: 育儿假天数
  - maternityLeaveWorkingDays: 产假工作日天数
  - weekendOvertimeHours: 公休日加班（小时）
  - legalHolidayOvertimeHours: 法定假日加班（小时）
  - lateMinutes: 迟到时长（分钟）
  - earlyLeaveMinutes: 早退时长（分钟）
  - overtimeHours: 工作日加班时长（小时）
  - actualWorkingHours: 实际工作时长（小时）
  - businessTripHours: 公出时长（小时）
  - paternityLeaveWorkingDays: 陪产假工作日天数
  - shift: 工作班次
  - isAbsent: 是否缺勤
  - calculationStatus: 计算状态（SUCCESS/FAILED/PENDING/PROCESSING）
  - calculationMessage: 计算消息
  - lastCalculatedAt: 最后计算时间
- **索引设计**:
  - 复合唯一索引：(employeeId, reportDate)
  - 单独索引：reportDate（便于按日期查询）
  - 单独索引：calculationStatus（便于按状态查询）

#### 3.1.2 考勤月报表 (attendance_monthly_reports)
- **主要字段**:
  - employeeId: 员工ID（外键）
  - reportMonth: 报告月份（YYYY-MM格式）
  - employeeNo: 员工工号
  - realName: 真实姓名
  - nickname: 员工昵称
  - expectedWorkingDays: 应出勤天数
  - actualWorkingDays: 实出勤天数
  - legalHolidayDays: 法定假日天数
  - absentDays: 缺勤天数
  - personalLeaveDays: 事假天数
  - annualLeaveDays: 年假天数
  - compensatoryLeaveDays: 调休假天数
  - sickLeaveDays: 病假天数
  - breastfeedingLeaveDays: 哺乳假天数
  - prenatalCheckupLeaveDays: 孕检假天数
  - childcareLeaveDays: 育儿假天数
  - marriageLeaveDays: 婚假天数
  - paternityLeaveDays: 陪产假天数
  - maternityLeaveDays: 产假天数
  - bereavementLeaveDays: 丧假天数
  - workInjuryLeaveDays: 工伤假天数
  - homeVisitLeaveDays: 探亲假天数
  - totalLateMinutes: 迟到总时长（分钟）
  - totalEarlyLeaveMinutes: 早退总时长（分钟）
  - makeupCardCount: 补卡次数
  - weekendOvertimeHours: 公休日加班（小时）
  - legalHolidayOvertimeHours: 法定假日加班（小时）
  - businessTripNightAllowance: 出差宵夜补贴（元）
  - workingDayDutyAllowance: 工作日值班补贴（元）
  - confirmationStatus: 确认状态（DRAFT/PENDING/CONFIRMED/REJECTED/LOCKED）
  - confirmationInitiatedAt: 发起确认时间
  - confirmationCompletedAt: 确认完成时间
  - confirmedBy: 确认人ID
  - lastCalculatedAt: 最后计算时间
  - remark: 备注信息
  - calculationSnapshot: 计算基础数据快照（JSON）
- **索引设计**:
  - 复合唯一索引：(employeeId, reportMonth)
  - 单独索引：reportMonth（便于按月份查询）
  - 单独索引：confirmationStatus（便于按确认状态查询）

#### 3.1.3 工资详情表 (salary_details)
- **主要字段**:
  - employeeId: 员工ID（外键关联employees表）
  - attendanceMonthlyReportId: 月度考勤报告ID（外键关联attendance_monthly_reports表）
  - reportMonth: 工资月份（YYYY-MM格式）
  - employeeNo: 员工工号
  - employeeName: 员工姓名
  - expectedWorkingDays: 应出勤天数
  - actualWorkingDays: 实出勤天数
  - baseSalary: 综合合计（每月的正常薪酬）
  - attendanceSalary: 考勤工资（根据实际出勤天数计算）
  - personalLeaveDeduction: 事假扣款
  - allowanceAndBonus: 补助/奖金
  - grossSalary: 应发工资（考勤工资 - 事假扣款 + 补助奖金）
  - socialInsurance: 社保（个人部分）
  - housingFund: 住房公积金（个人部分）
  - incomeTax: 个人所得税
  - mealFee: 伙食费
  - otherDeductions: 其他扣款
  - netSalary: 实发工资（应发工资 - 社保 - 公积金 - 个税 - 伙食费 - 其他扣款）
  - status: 工资详情状态（DRAFT/CALCULATED/CONFIRMED/PAID/CANCELLED）
  - calculatedAt: 工资计算时间
  - confirmedAt: 工资确认时间
  - confirmedBy: 确认人ID
  - paidAt: 工资发放时间
  - paidBy: 发放人ID
  - remark: 备注信息
  - calculationSnapshot: 工资计算数据快照（JSON格式，用于审计追溯）
- **索引设计**:
  - 复合唯一索引：(employeeId, reportMonth)
  - 单独索引：reportMonth（便于按月份查询）
  - 单独索引：status（便于按状态查询）
  - 单独索引：calculatedAt、confirmedAt、paidAt（便于按时间查询）

### 3.2 关联表
- 用户角色表 (user_roles)
- 员工门店表 (employee_stores)
- 考勤规则表 (attendance_rules)

## 4. API接口设计

### 4.1 RESTful API

#### 4.1.1 员工管理接口
- GET /api/employees - 获取员工列表
- POST /api/employees - 创建员工
- GET /api/employees/:id - 获取员工详情
- PUT /api/employees/:id - 更新员工信息
- DELETE /api/employees/:id - 删除员工

#### 4.1.2 考勤管理接口
- GET /api/attendance - 获取考勤记录
- POST /api/attendance/checkin - 打卡
- POST /api/attendance/import - 批量导入考勤数据
- PUT /api/attendance/:id - 更新考勤记录
- DELETE /api/attendance/:id - 删除考勤记录

#### 4.1.3 报表统计接口 (新增)

##### 日报相关接口
- GET /api/reports/daily-reports - 获取考勤日报列表
  - 支持查询参数：employeeId, startDate, endDate, calculationStatus, page, pageSize
- POST /api/reports/calculate - 手动触发考勤日报计算
  - 请求体：{startDate?, endDate?, employeeId?, forceRecalculate?}
- POST /api/reports/trigger-calculation - 触发指定日期的考勤计算
  - 请求体：{date, employeeIds?}
- GET /api/reports/calculation-status - 获取计算状态统计
  - 支持查询参数：startDate, endDate

##### 月报相关接口
- GET /api/reports/monthly-reports - 获取考勤月报列表
  - 支持查询参数：employeeId, reportMonth, confirmationStatus, page, pageSize
- POST /api/reports/calculate-monthly - 手动触发考勤月报计算
  - 请求体：{employeeId?, reportMonth}
- GET /api/reports/monthly-reports/:id - 获取月报详情
  - 路径参数：id（月报ID）
- POST /api/reports/monthly-reports/:id/confirm - 确认月报
  - 路径参数：id（月报ID）
  - 请求体：{remark?}
- POST /api/reports/monthly-reports/batch-confirm - 批量确认月报
  - 请求体：{ids: number[], remark?}
- GET /api/reports/monthly-stats - 获取月报统计信息
  - 支持查询参数：reportMonth

#### 4.1.4 薪酬管理接口 (新增)

##### 工资详情相关接口
- GET /api/salary - 获取工资详情列表
  - 支持查询参数：employeeId, employeeNo, employeeName, reportMonth, status, startMonth, endMonth, confirmedBy, paidBy, page, limit, sortBy, sortOrder
- POST /api/salary - 创建工资详情
  - 请求体：员工ID、月份、工资详情等信息
- GET /api/salary/:id - 获取工资详情详情
  - 路径参数：id（工资详情ID）
- PATCH /api/salary/:id - 更新工资详情
  - 路径参数：id（工资详情ID）
  - 请求体：更新的工资详情信息
- DELETE /api/salary/:id - 删除工资详情
  - 路径参数：id（工资详情ID）

##### 工资计算相关接口
- POST /api/salary/calculate - 计算员工工资
  - 请求体：{reportMonth, employeeIds?, forceRecalculate?}
- POST /api/salary/batch-calculate - 批量计算多月工资
  - 请求体：{reportMonths: string[], employeeIds?, forceRecalculate?}
- PATCH /api/salary/:id/confirm - 确认工资详情
  - 路径参数：id（工资详情ID）
  - 请求体：{confirmedBy: number}
- PATCH /api/salary/:id/pay - 标记工资已发放
  - 路径参数：id（工资详情ID）
  - 请求体：{paidBy: number}
- GET /api/salary/statistics/:reportMonth - 获取月度工资统计
  - 路径参数：reportMonth（报告月份）

#### 4.1.5 假勤管理接口
- GET /api/leave - 获取请假记录
- POST /api/leave - 提交请假申请
- PUT /api/leave/:id - 审批请假申请

## 5. 安全设计

### 5.1 身份认证
- JWT Token认证
- 密码加密存储
- 登录失败限制

### 5.2 权限控制
- 基于角色的权限控制
- 数据权限控制
- 操作权限验证

## 6. 性能优化

### 6.1 数据库优化
- 索引优化
- 查询优化
- 分页查询

### 6.2 缓存策略
- Redis缓存
- 查询结果缓存
- 静态资源缓存

## 7. 考勤日报自动计算系统设计

### 7.1 系统架构图
```
考勤数据 → 自动计算引擎 → 日报数据
    ↓           ↓            ↓
Excel导入   定时任务     数据查询API
    ↓           ↓            ↓
触发计算   凌晨2点执行   前端展示
```

### 7.2 核心算法设计

#### 7.2.1 迟到时长计算
```typescript
迟到分钟数 = max(0, 实际打卡时间 - 应打卡时间)
```

#### 7.2.2 实际工作时长计算
```typescript
工作时长 = max(0, 最晚下班时间 - 最早上班时间 - 午休时间)
```

#### 7.2.3 公出时长识别
- 基于备注关键词：「公出」、「外出」、「出差」
- 每条公出记录按4小时计算（可配置）

### 7.3 自动化流程设计

#### 7.3.1 定时计算流程
1. 每日凌晨2点触发定时任务
2. 查询所有active状态员工
3. 计算前一天的考勤数据
4. 避免重复计算已成功的记录
5. 记录计算状态和错误信息

#### 7.3.2 导入触发流程
1. Excel数据导入完成
2. 异步提取涉及的日期和员工
3. 按日期分组触发计算
4. 计算失败不影响导入成功

#### 7.3.3 手动触发流程
1. 支持指定日期范围计算
2. 支持单个或多个员工计算
3. 支持强制重新计算
4. 实时返回处理结果

### 7.4 状态管理机制

#### 7.4.1 计算状态定义
- **PENDING**: 等待计算
- **PROCESSING**: 计算中
- **SUCCESS**: 计算成功
- **FAILED**: 计算失败

#### 7.4.2 错误处理策略
- 单个员工计算失败不影响其他员工
- 记录详细错误信息便于排查
- 支持失败记录的重新计算

### 7.5 性能优化策略

#### 7.5.1 批量处理
- 数据库批量查询和保存
- 减少数据库连接次数
- 异步处理大量数据

#### 7.5.2 索引优化
- employeeId + reportDate复合索引
- reportDate单独索引
- calculationStatus索引

#### 7.5.3 缓存策略
- 员工信息缓存
- 计算结果缓存
- 减少重复查询

### 7.6 扩展设计

#### 7.6.1 支持的扩展功能
- 自定义计算规则配置
- 多种班次类型支持
- 节假日特殊处理
- 请假数据联动计算

#### 7.6.2 监控和告警
- 计算失败率监控
- 处理时间监控
- 数据异常告警
- 计算结果准确性验证

## 8. 考勤月报自动汇总系统设计

### 8.1 系统架构图
```
日报数据 → 月报汇总引擎 → 月报数据
    ↓           ↓            ↓
日报完成   自动触发计算   状态流程管理
    ↓           ↓            ↓
触发月报   智能数据汇总   确认审批流程
```

### 8.2 核心汇总算法设计

#### 8.2.1 出勤天数统计
```typescript
// 应出勤天数计算（排除周末和法定假日）
expectedWorkingDays = 工作日总数 - 法定假日数
// 实出勤天数统计
actualWorkingDays = 日报记录总数 - 缺勤天数
```

#### 8.2.2 时间汇总计算
```typescript
// 迟到总时长
totalLateMinutes = sum(dailyReports.lateMinutes)
// 加班时间分类汇总
weekendOvertimeHours = sum(dailyReports.weekendOvertimeHours)
legalHolidayOvertimeHours = sum(dailyReports.legalHolidayOvertimeHours)
```

#### 8.2.3 假期统计汇总
```typescript
// 各类假期天数汇总
annualLeaveDays = sum(dailyReports.annualLeaveDays)
personalLeaveDays = sum(dailyReports.personalLeaveDays)
sickLeaveDays = sum(dailyReports.sickLeaveDays)
// ... 其他假期类型
```

### 8.3 自动化触发机制

#### 8.3.1 日报完成触发流程
1. 日报计算完成后自动识别涉及月份
2. 提取该月份需要重新计算的员工
3. 基于已有日报数据进行汇总计算
4. 更新或创建月报记录
5. 保留已确认状态的月报数据

#### 8.3.2 定时任务集成
1. 每日凌晨2点定时任务包含月报计算
2. 自动处理前一天影响的月份
3. 批量处理多个员工的月报更新
4. 记录计算日志和错误信息

#### 8.3.3 手动触发流程
1. 支持指定月份的全量计算
2. 支持单个员工的月报重算
3. 提供强制重新计算选项
4. 实时返回处理结果和统计

### 8.4 状态流程管理

#### 8.4.1 月报状态定义
- **DRAFT**: 草稿状态，允许重新计算
- **PENDING**: 待确认状态，等待审批
- **CONFIRMED**: 已确认状态，不允许重新计算
- **REJECTED**: 已拒绝状态，可重新提交
- **LOCKED**: 已锁定状态，完全禁止修改

#### 8.4.2 状态流转规则
```
DRAFT → PENDING → CONFIRMED
   ↑        ↓         ↓
   └─── REJECTED → LOCKED
```

#### 8.4.3 保护机制
- 已确认状态月报不会被自动重新计算
- 提供确认状态检查和跳过逻辑
- 支持管理员强制解锁功能
- 记录状态变更历史和操作人

### 8.5 数据汇总策略

#### 8.5.1 基于日报的汇总
- 从AttendanceDailyReport表中提取月度数据
- 按月份和员工进行分组汇总
- 智能处理缺失日报的情况
- 提供数据完整性检查

#### 8.5.2 计算快照机制
- 记录汇总计算的基础数据
- 保存日报ID列表用于审计
- 存储计算时间和参数信息
- 支持数据溯源和问题排查

#### 8.5.3 异常处理策略
- 单个员工月报计算失败不影响其他员工
- 记录详细的错误信息和堆栈
- 提供失败重试机制
- 支持部分数据的降级处理

### 8.6 性能优化设计

#### 8.6.1 批量处理优化
- 数据库批量查询和更新操作
- 减少数据库连接和事务次数
- 异步处理大量员工数据
- 内存中进行数据汇总计算

#### 8.6.2 索引和查询优化
- (employeeId, reportMonth) 复合唯一索引
- reportMonth 单独索引支持月份查询
- confirmationStatus 索引支持状态筛选
- 优化日报数据查询SQL语句

#### 8.6.3 缓存策略
- 员工基础信息缓存
- 月份工作日天数缓存
- 法定假日数据缓存
- 计算结果临时缓存

### 8.7 业务流程集成

#### 8.7.1 与日报系统联动
- 日报计算完成自动触发月报
- 智能识别跨月份的日期范围
- 处理日报数据变更的月报更新
- 保持数据一致性和完整性

#### 8.7.2 确认审批流程
- 支持HR管理员确认月报
- 提供批量确认功能
- 记录确认操作的时间和人员
- 支持确认意见和备注信息

#### 8.7.3 报表导出功能
- 支持月报数据Excel导出
- 提供多种格式的报表模板
- 支持按月份、部门等维度筛选
- 包含完整的统计汇总信息

### 8.8 监控和运维

#### 8.8.1 计算监控指标
- 月报计算成功率
- 平均计算处理时间
- 确认流程完成率
- 数据完整性检查

#### 8.8.2 告警机制
- 计算失败率超阈值告警
- 长时间未确认月报提醒
- 数据异常情况告警
- 系统性能异常监控

#### 8.8.3 运维支持
- 详细的操作日志记录
- 计算过程可视化监控
- 手动干预和修复工具
- 数据备份和恢复机制

## 9. 工资计算系统设计

### 9.1 系统架构图
```
员工基础薪资 + 月度考勤报告 → 工资计算引擎 → 工资详情
       ↓                ↓            ↓
   employees表    attendance_monthly   salary_details表
       ↓           _reports表          ↓
   baseSalary      考勤数据         状态流转管理
       ↓                ↓            ↓
   计算基础          计算触发        确认发放流程
```

### 9.2 工资计算核心算法

#### 9.2.1 基础费率计算
```typescript
// 标准工时制月计薪天数为21.75天
日工资 = 月标准工资 ÷ 21.75天
小时工资 = 日工资 ÷ 8小时
```

#### 9.2.2 考勤工资计算
```typescript
// 基于实际出勤比例计算正常出勤工资
出勤比例 = 实出勤天数 ÷ 应出勤天数
正常出勤工资 = 月标准工资 × 出勤比例
```

#### 9.2.3 扣款计算
```typescript
// 事假扣款
事假扣款 = 日工资 × 事假天数
```

#### 9.2.4 加班费计算
```typescript
// 休息日加班费（200%）
休息日加班费 = 日工资 × 200% × (休息日加班小时数 ÷ 8小时)

// 法定节假日加班费（300%）
法定节假日加班费 = 日工资 × 300% × (法定节假日加班小时数 ÷ 8小时)

// 延时加班费（150%）
延时加班费 = 小时工资 × 150% × 延时加班小时数
```

#### 9.2.5 最终工资计算
```typescript
// 考勤工资 = 正常出勤工资 - 扣款 + 加班费
考勤工资 = 正常出勤工资 - 事假扣款 + 休息日加班费 + 法定节假日加班费 + 延时加班费

// 应发工资 = 考勤工资 + 补助奖金
应发工资 = 考勤工资 + 补助奖金

// 实发工资 = 应发工资 - 各项扣除
实发工资 = 应发工资 - 社保 - 公积金 - 个税 - 伙食费 - 其他扣款
```

### 9.3 计算触发机制

#### 9.3.1 数据依赖关系
1. **员工基础数据**: 从employees表获取baseSalary
2. **考勤数据**: 从attendance_monthly_reports表获取已确认状态的月报
3. **计算前置条件**: 月度考勤报告必须为CONFIRMED状态

#### 9.3.2 触发方式
- **手动单月计算**: 指定月份和员工范围进行计算
- **批量多月计算**: 支持多个月份的批量处理
- **强制重新计算**: 覆盖已存在的工资记录
- **防重复机制**: 已计算的记录不会重复处理

#### 9.3.3 计算流程
1. 验证输入参数和权限
2. 获取符合条件的员工列表
3. 检查月度考勤报告确认状态
4. 执行工资计算核心逻辑
5. 创建或更新工资详情记录
6. 返回计算结果和统计

### 9.4 状态管理系统

#### 9.4.1 工资状态定义
- **DRAFT**: 草稿状态，可以修改
- **CALCULATED**: 已计算状态，等待确认
- **CONFIRMED**: 已确认状态，不允许修改
- **PAID**: 已发放状态，完成流程
- **CANCELLED**: 已取消状态

#### 9.4.2 状态流转规则
```
DRAFT → CALCULATED → CONFIRMED → PAID
   ↑         ↓            ↓
   └─── CANCELLED ←──────┘
```

#### 9.4.3 操作权限控制
- **计算权限**: HR管理员可执行工资计算
- **确认权限**: HR管理员可确认工资详情
- **发放权限**: 财务人员可标记发放状态
- **查询权限**: 员工只能查看自己的工资详情

### 9.5 数据完整性保障

#### 9.5.1 计算快照机制
- **完整计算过程记录**: 保存计算的所有中间结果
- **基础数据快照**: 记录计算时使用的员工和考勤数据
- **审计追溯**: 支持查看历史计算过程和数据变更

#### 9.5.2 数据一致性检查
- **外键约束**: 确保员工和考勤报告数据的完整性
- **唯一性约束**: 每个员工每月只能有一条工资记录
- **状态一致性**: 确保状态流转的合法性

#### 9.5.3 错误处理策略
- **单个失败隔离**: 单个员工计算失败不影响其他员工
- **详细错误记录**: 记录错误原因和堆栈信息
- **批量结果汇总**: 提供成功/失败统计和错误摘要

### 9.6 性能优化设计

#### 9.6.1 批量处理优化
- **数据库批量操作**: 减少数据库连接次数
- **内存计算**: 在内存中完成复杂计算逻辑
- **异步处理**: 大量数据的异步处理机制

#### 9.6.2 索引优化策略
- **复合索引**: (employeeId, reportMonth) 支持快速查询
- **状态索引**: status字段索引支持状态筛选
- **时间索引**: 计算时间、确认时间、发放时间索引

#### 9.6.3 缓存策略
- **员工信息缓存**: 避免重复查询员工基础数据
- **计算结果缓存**: 临时缓存中间计算结果
- **配置数据缓存**: 缓存计算配置和规则

### 9.7 扩展性设计

#### 9.7.1 计算规则配置化
- **费率配置**: 支持调整加班费率和计算规则
- **扣款规则**: 支持自定义扣款项目和计算方式
- **补助规则**: 支持灵活配置各种补助和奖金

#### 9.7.2 多种薪酬模式支持
- **固定薪酬**: 基于基础工资的标准计算
- **计件薪酬**: 基于产量的薪酬计算（扩展）
- **提成薪酬**: 基于销售业绩的提成计算（扩展）

#### 9.7.3 集成扩展能力
- **社保公积金系统**: 自动获取缴费基数和比例
- **个税系统**: 集成个税计算引擎
- **财务系统**: 工资数据推送到财务系统

### 9.8 监控和运维

#### 9.8.1 计算监控指标
- **计算成功率**: 监控工资计算的成功比例
- **计算耗时**: 监控计算性能和响应时间
- **数据准确性**: 验证计算结果的准确性

#### 9.8.2 业务监控
- **确认及时性**: 监控工资确认的及时性
- **发放完成率**: 统计工资发放的完成情况
- **异常工资预警**: 识别异常的工资计算结果

#### 9.8.3 运维支持
- **操作日志**: 详细记录所有操作和变更
- **数据备份**: 重要工资数据的备份机制
- **故障恢复**: 计算失败的重试和恢复机制

---

**文档更新记录**：
- v1.3 (2024-12): 新增工资计算系统设计
- v1.2 (2024-12): 新增考勤月报自动汇总功能设计
- v1.1 (2024-12): 新增考勤日报自动计算功能设计
- v1.0 (2024-12): 初始版本
