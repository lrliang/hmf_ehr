# HMF EHR 系统端口配置说明

## 📋 端口分配总览

为了支持开发环境和生产环境在同一台服务器上并行运行，我们采用了不同的端口分配策略。

## 🏭 生产环境端口

| 服务名称 | 容器名称 | 内部端口 | 外部端口 | 访问地址 | 说明 |
|----------|----------|----------|----------|----------|------|
| Nginx | hmf_ehr_nginx | 80, 443 | 80, 443 | http://localhost | 统一入口 |
| Frontend | hmf_ehr_frontend | 80 | - | - | 通过Nginx代理 |
| Backend | hmf_ehr_backend | 8080 | 8080 | http://localhost:8080 | API服务 |
| PostgreSQL | hmf_ehr_postgres | 5432 | 5432 | localhost:5432 | 数据库 |
| Redis | hmf_ehr_redis | 6379 | 6379 | localhost:6379 | 缓存 |

## 🛠️ 开发环境端口

| 服务名称 | 容器名称 | 内部端口 | 外部端口 | 访问地址 | 说明 |
|----------|----------|----------|----------|----------|------|
| Nginx-Dev | hmf_ehr_nginx_dev | 80 | 8090 | http://localhost:8090 | 开发代理 |
| Frontend-Dev | hmf_ehr_frontend_dev | 3000 | 3001 | http://localhost:3001 | React开发服务器 |
| Backend-Dev | hmf_ehr_backend_dev | 8080 | 8081 | http://localhost:8081 | NestJS开发服务器 |
| Backend-Debug | hmf_ehr_backend_dev | 9229 | 9230 | - | Node.js调试端口 |
| PostgreSQL-Dev | hmf_ehr_postgres_dev | 5432 | 5433 | localhost:5433 | 开发数据库 |
| Redis-Dev | hmf_ehr_redis_dev | 6379 | 6380 | localhost:6380 | 开发缓存 |

## 🔄 访问方式对比

### 生产环境访问
```bash
# 前端应用
curl http://localhost

# API接口
curl http://localhost/api/v1/health

# API文档
open http://localhost/api/v1/docs

# 直连数据库
psql -h localhost -p 5432 -U postgres -d hmf_ehr

# 直连Redis
redis-cli -h localhost -p 6379
```

### 开发环境访问
```bash
# 前端应用 (直连)
curl http://localhost:3001

# 前端应用 (通过Nginx)
curl http://localhost:8090

# API接口 (直连)
curl http://localhost:8081/api/v1/health

# API接口 (通过Nginx)
curl http://localhost:8090/api/v1/health

# API文档
open http://localhost:8081/api/v1/docs

# 直连开发数据库
psql -h localhost -p 5433 -U postgres -d hmf_ehr_dev

# 直连开发Redis
redis-cli -h localhost -p 6380
```

## 🔧 端口冲突解决

### 常见端口冲突
如果遇到端口占用问题，可以检查和处理：

```bash
# 检查端口占用
lsof -i :80
lsof -i :3001
lsof -i :5432
lsof -i :5433

# 停止占用端口的进程
sudo kill -9 <PID>

# 或者修改docker-compose文件中的端口映射
```

### 自定义端口配置
如需修改端口，请编辑以下文件：

1. **生产环境**: `docker-compose.yml`
2. **开发环境**: `docker-compose.dev.yml`
3. **Nginx配置**: `nginx/conf.d/default.conf` 和 `nginx/conf.d/dev.conf`

## 🌐 网络配置

### 生产环境网络
- 网络名称: `hmf_ehr_network`
- 子网: `172.20.0.0/16`
- 驱动: bridge

### 开发环境网络
- 网络名称: `hmf_ehr_dev_network`
- 驱动: bridge

## 🚀 启动命令

### 启动生产环境
```bash
./scripts/start.sh prod
# 或
./scripts/start.sh
```

### 启动开发环境
```bash
./scripts/start.sh dev
```

### 同时运行两个环境
```bash
# 终端1: 启动生产环境
./scripts/start.sh prod

# 终端2: 启动开发环境
./scripts/start.sh dev
```

## 📊 服务健康检查

### 生产环境健康检查
```bash
# 系统健康
curl http://localhost/health

# Nginx状态
curl http://localhost/nginx_status

# 后端健康
curl http://localhost/api/v1/health
```

### 开发环境健康检查
```bash
# 开发环境健康
curl http://localhost:8090/dev-health

# 前端健康
curl http://localhost:3001

# 后端健康
curl http://localhost:8081/api/v1/health
```

## 🔒 防火墙配置

如果使用防火墙，需要开放以下端口：

### 生产环境端口
```bash
# HTTP/HTTPS
sudo ufw allow 80
sudo ufw allow 443

# 数据库 (如需外部连接)
sudo ufw allow 5432

# Redis (如需外部连接)
sudo ufw allow 6379
```

### 开发环境端口
```bash
# 开发服务端口
sudo ufw allow 3001
sudo ufw allow 8081
sudo ufw allow 8090

# 开发数据库
sudo ufw allow 5433

# 开发Redis
sudo ufw allow 6380

# 调试端口
sudo ufw allow 9230
```

## 📝 注意事项

1. **端口冲突**: 确保所选端口未被其他服务占用
2. **防火墙**: 根据需要开放相应端口
3. **数据隔离**: 开发环境和生产环境使用不同的数据库
4. **配置同步**: 修改端口后需要同步更新相关配置文件
5. **SSL证书**: 生产环境建议配置真实SSL证书
6. **监控**: 定期检查服务健康状态

## 🆘 故障排除

### 端口占用问题
```bash
# 查看端口占用
netstat -tlnp | grep :80

# 强制停止服务
docker-compose down --remove-orphans
```

### 网络连接问题
```bash
# 检查Docker网络
docker network ls

# 重建网络
docker-compose down
docker network prune
docker-compose up -d
```

### 服务无法启动
```bash
# 查看服务日志
docker-compose logs [service_name]

# 重启特定服务
docker-compose restart [service_name]
```
